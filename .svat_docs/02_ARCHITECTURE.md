# 2. アプリケーションアーキテクチャ (Application Architecture)

本アプリケーションは、コードの保守性、可読性、拡張性を高めるため、「関心の分離 (Separation of Concerns)」の原則に基づき、以下のコンポーネントに分割する。

## 2.1. main.py (エントリーポイント)
-   **役割**: アプリケーションの起動のみを担当するスクリプト。
-   **責務**:
    -   動画ファイル選択ダイアログを表示する。
    -   メインウィンドウ (`MainWindow`) をインスタンス化し、アプリケーションのメインループを開始する。
    -   複数動画が選択された場合、そのリストを `MainWindow` に渡す。

## 2.2. UI (View) - `app/main_window.py`
-   **役割**: ユーザーインターフェースの構築と表示を担当する。
-   **責務**:
    -   `tkinter` を用いたウィンドウ、フレーム、ウィジェット（ボタン、ラベル、ツリービュー等）の生成と配置。
    -   UI要素の見た目の設定。
    -   ユーザー操作（ボタンクリック、キー入力など）を検知し、`AppLogic` のメソッドを呼び出す（コールバック）。
    -   UIの状態（ボタンの有効/無効など）を `AppLogic` からの指示で更新する。
    -   **ロジックを一切含まない**。状態の保持や計算は行わない。

## 2.3. アプリケーションロジック (Controller) - `app/app_logic.py`
-   **役割**: UI (View) とビジネスロジック (Service) を繋ぐ「司令塔」。
-   **責務**:
    -   `MainWindow` からのユーザー操作イベントを受け取る。
    -   イベントに応じて、適切なサービスクラスのメソッドを呼び出す。 (例: 「再生ボタンが押された」→ `VideoPlayerService.play()`)
    -   サービスからの処理結果やデータの変更を受け取り、`MainWindow` の表示を更新するよう指示する。
    -   アプリケーション全体の状態（例: 現在記録中か、どの手順が選択されているか）を保持・管理する。

## 2.4. ビジネスロジック (Services)
-   **役割**: アプリケーションの具体的な「機能」を実現する独立したコンポーネント群。

### 2.4.1. `services/video_player.py` - VideoPlayerService
-   **責務**: `python-vlc` ライブラリをラップし、動画再生に関するすべての機能をカプセル化する。
    -   動画の読み込み（単一または複数）、再生、一時停止、シーク、速度変更。
    -   現在の再生時間や総再生時間の取得。
    -   プレイリストを管理し、複数動画をシームレスに再生する。

### 2.4.2. `services/analysis_service.py` - AnalysisService
-   **責務**: 手術手順のタイムスタンプ記録とデータ管理を行う。
    -   手順の開始・終了時刻の記録。
    -   記録済みデータのリストを保持。
    -   Undo（直前の記録の取り消し）機能。
    -   合計時間などのサマリー情報を計算。

### 2.4.3. `services/preset_service.py` - PresetService
-   **責務**: プリセットデータの永続化（ファイルI/O）と管理を行う。
    -   `procedure_presets.json` の読み込みと書き込み。
    -   プリセットの追加、名前変更、削除。
    -   現在使用中のプリセットの管理。

### 2.4.4. `services/settings_service.py` - SettingsService
-   **責務**: アプリケーション設定の永続化を行う。
    -   `app_settings.json` の読み込みと書き込み。（ウィンドウサイズ、オプション設定など）

### 2.4.5. `services/export_service.py` - ExportService
-   **責務**: 分析結果をファイルに出力する。
    -   `pandas` を用いてCSVファイルを生成する。
    -   `matplotlib` を用いてグラフ画像を生成する。

## 2.5. 設定・定数 - `app/config.py`
-   **役割**: アプリケーション全体で使用される定数や設定値を一元管理する。
-   **責務**:
    -   ファイルパス、デフォルトのプリセット名、UIの文字列など、変更される可能性のある値を定義する。