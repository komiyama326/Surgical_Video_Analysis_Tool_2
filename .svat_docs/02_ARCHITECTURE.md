# 02_ARCHITECTURE.md

## アプリケーションアーキテクチャ

本アプリケーションは、**MVVM (Model-View-ViewModel)** の設計思想を参考に、以下の3つの主要コンポーネントに責務を分割して構築する。これにより、UIロジックとビジネスロジックの分離を図り、コードの保守性・テスト性・拡張性を向上させる。

### 1. Model (データとビジネスロジック)

アプリケーションの核となるデータとその操作を担当する。UI（見た目）には一切関知しない。

-   **`VideoPlayerModel`**:
    -   責務: 動画の再生、一時停止、シーク、再生速度の制御。
    -   担当ライブラリ: `python-vlc`
    -   状態: 現在の再生時間、動画の総再生時間、再生状態（再生中/一時停止中）、動画リストなど。
-   **`AnalysisDataModel`**:
    -   責務: 手術手順のタイムスタンプデータ（開始時間、終了時間など）の記録と管理。
    -   状態: 記録された手順データのリスト。
    -   機能: データの追加（End）、削除（Undo）。
-   **`PresetModel`**:
    -   責務: 手順名プリセットの読み込み、保存、編集（追加/削除/名前変更）。
    -   状態: 現在のプリセットリスト、選択されているプリセット名。
-   **`SettingsModel`**:
    -   責務: アプリケーションの設定（ウィンドウサイズなど）の読み込みと保存。

### 2. View (UI)

ユーザーインターフェースの構築と表示を担当する。原則として、自身の状態管理や複雑なロジックは持たない。ViewModelからの指示に従い、画面を描画・更新する。

-   **`MainWindow` (Tkinter)**:
    -   責務: アプリケーションのメインウィンドウと全体のレイアウトを構築する。
    -   コンポーネント:
        -   **`VideoFrame`**: 動画を表示する領域。
        -   **`ControlPanel`**: 再生/停止ボタン、タイムラインスライダー、速度調整ボタンなどを配置する領域。
        -   **`StampPanel`**: 手順プリセットを表示・選択するリスト（Treeview）、およびプリセット管理ボタンを配置する領域。
        -   **`StatusPanel`**: 現在の記録状態や選択中の手順名を表示する領域。

### 3. ViewModel (橋渡し)

Viewからのユーザー操作を受け取り、それを解釈して適切なModelの処理を呼び出す。また、Modelの状態変化を監視し、Viewに画面の更新を指示する。

-   **`MainViewModel`**:
    -   責務: アプリケーション全体のロジックと状態を管理し、ViewとModelの間の調整役を担う。
    -   ロジック:
        -   「再生/一時停止ボタン」が押されたら、`VideoPlayerModel` の再生/一時停止メソッドを呼び出す。
        -   `VideoPlayerModel` の再生時間が更新されたら、`MainWindow` のタイムラインスライダーと時間表示を更新する。
        -   「Startボタン」が押されたら、現在の再生時間を `VideoPlayerModel` から取得し、`AnalysisDataModel` に記録を開始させる。
        -   `AnalysisDataModel` のデータが更新されたら、`StatusPanel` のサマリー表示を更新する。
        -   `PresetModel` のプリセットリストが変更されたら、`StampPanel` のリスト表示を更新する。
        -   ファイル保存時には、`AnalysisDataModel` のデータを整形し、CSVやグラフとして出力する。